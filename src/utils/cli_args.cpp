#include "utils/cli_args.h"

#include <iostream>
#include <string>

#include "app_config.h"

namespace cli_args {

void PrintUsage(const char* argv0, std::ostream& os) {
	os
		<< "Cach dung:\n"
		<< "  " << argv0 << " --image <duong_dan_anh.jpg>\n\n"
		<< "  " << argv0 << " --folder <duong_dan_thu_muc_anh>\n\n"
		<< "Ghi chu:\n"
		<< "  - Pipeline: vehicle_detection (YOLO26 NMS-free) -> plate_detection (YOLO26 NMS-free, batch) -> OCR plate (batch)\n"
		<< "  - Models (fix cung trong app_config.h):\n"
		<< "      vehicle: " << app_config::kVehicleModelPath << "\n"
		<< "      plate  : " << app_config::kPlateModelPath << "\n"
		<< "      ocr    : " << app_config::kOcrModelPath << "\n"
		<< "  - OCR preprocess: crop bien so -> RGB -> resize (" << app_config::kInputW << "x" << app_config::kInputH << ") -> uint8 NHWC\n"
		<< "  - Output: ghi anh <ten>_annotated.jpg va in cac bbox + text ra stdout\n";
}

Options Parse(int argc, char** argv) {
	Options opt;
	for (int i = 1; i < argc; ++i) {
		std::string a = argv[i];
		if ((a == "--image" || a == "-i") && i + 1 < argc) {
			opt.image_path = argv[++i];
		} else if ((a == "--folder" || a == "-f") && i + 1 < argc) {
			opt.folder_path = argv[++i];
		} else if (a == "--help" || a == "-h") {
			opt.show_help = true;
			return opt;
		} else {
			throw std::runtime_error("Tham so khong hop le: " + a);
		}
	}

	if (!opt.image_path.empty() && !opt.folder_path.empty()) {
		throw std::runtime_error("Chi duoc dung mot trong hai tham so: --image hoac --folder");
	}
	if (opt.image_path.empty() && opt.folder_path.empty()) {
		// giu hanh vi cu: cho phep fallback anh mac dinh trong main
	}
	return opt;
}

} // namespace cli_args
